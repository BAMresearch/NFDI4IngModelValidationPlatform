import os

# 1. Setup and Config
tool = "dumux"
result_dir = f"snakemake_results/rotating-cylinders/{tool}"
configurations = config["configurations"]
configuration_to_parameter_file = config["configuration_to_parameter_file"]
vtu_mapping = config["configuration_to_solution_vtu_files"]

container_image = "git.iws.uni-stuttgart.de:4567/benchmarks/rotating-cylinders:3.0"
shared_dir = os.getcwd()
# dumux_input = f"{shared_dir}/{tool}/input_files" 
dumux_dir = f"{shared_dir}/{tool}" 

# Rule 1: Only runs the simulation, outputs the VTU files
rule run_dumux_simulation:
    input:
        params=lambda wildcards: f"{dumux_dir}/input_files/{configuration_to_parameter_file[wildcards.configuration]}"
    output:
        # Use a list of the actual files you expect
        vtu_files = [
            f"{tool}/test_rotatingcylinders_{{configuration}}-00000.vtu",
            f"{tool}/test_rotatingcylinders_{{configuration}}-00001.vtu"
        ]
    resources:
        serial_run=1
    singularity:
        f"docker://{container_image}"
    shell:
        """
        set -euo pipefail
        cd /dumux/rotating-cylinders/build-cmake/test/freeflow/navierstokes/rotatingcylinders
        ./test_ff_navierstokes_rotatingcylinders {input.params} -IO.OutputPath {dumux_dir}
        """

# Rule 2: Only runs post-processing, depends on the VTU files
rule postprocess_dumux:
    input:
        sim_data = [
            f"{tool}/test_rotatingcylinders_{{configuration}}-00000.vtu",
            f"{tool}/test_rotatingcylinders_{{configuration}}-00001.vtu"
        ],
        postprocess_script=f"{tool}/run_dumux_postprocessing.py"
    output:
        metrics=f"{result_dir}/solution_metrics_{{configuration}}.json",
        fields=f"{result_dir}/solution_field_data_{{configuration}}.zip"
    shell:
        """
        python3 {input.postprocess_script} \
            --input_dumux_output_dir {dumux_dir} \
            --input_configuration {wildcards.configuration} \
            --output_solution_file_zip {output.fields} \
            --output_metrics_file {output.metrics}
        """