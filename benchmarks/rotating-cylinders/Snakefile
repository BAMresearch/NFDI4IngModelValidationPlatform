# benchmarks/rotating-cylinders/Snakefile
import json
import os

# Ensure the config exists before loading
if not os.path.exists("rotating-cylinders_config.json"):
    # Run the generator script if the file is missing
    os.system("python3 generate_rc_config.py")

configfile: "rotating-cylinders_config.json"

# Variables for clarity
tools = config["tools"]
CONFIGS = config["configurations"]
RESULT_DIR = f"snakemake_results/{config['benchmark']}"
shared_dir = os.getcwd()
dumux_dir = f"{shared_dir}/dumux"

rule all:
    input:
        # This will create paths for every tool in every configuration
        expand(
            f"{RESULT_DIR}/{{tool}}/solution_metrics_{{configuration}}.json",
            tool=tools,
            configuration=CONFIGS
        )

# Divide and Conquer: This rule handles the templating for EACH configuration
rule generate_dumux_input:
    input:
        template = "params.template"
    output:
        # f-string uses double braces for Snakemake wildcards to escape Python evaluation
        param_file = f"{dumux_dir}/input_files/params_{{configuration}}.input"
    run:
        # Split "10_80" into c0="10" and c1="80"
        c0, c1 = wildcards.configuration.split("_")
        
        with open(input.template, "r") as f:
            content = f.read()
            
        formatted = content.format(
            cells0_x=c0,
            cells0_y=c0,
            cells1=c1,
            problem_name=f"/dumux/shared/dumux/test_rotatingcylinders_{c0}_{c1}"
        )
        
        os.makedirs(os.path.dirname(output.param_file), exist_ok=True)
        with open(output.param_file, "w") as f:
            f.write(formatted)

# Include tool specific rules
for tool in tools:
    include: f"{tool}/Snakefile"

# # Global Summary Rule
# rule summary:
#     input:
#         # Cross-reference the expand to ensure all metrics exist
#         metrics = expand(f"{RESULT_DIR}/dumux/solution_metrics_{{configuration}}.json", configuration=CONFIGS)
#     output:
#         json = f"{RESULT_DIR}/dumux/summary.json"
#     shell:
#         "python3 summarize.py --input {input.metrics} --output {output.json}"
