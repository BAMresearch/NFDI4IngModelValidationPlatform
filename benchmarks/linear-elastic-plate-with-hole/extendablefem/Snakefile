
import json
import os

tool = "extendablefem"
result_dir = "snakemake_results/" + config["benchmark"] 
configuration_to_parameter_file = config["configuration_to_parameter_file"]
configurations = config["configurations"]

rule setup_julia_environment:
    input: f"{tool}/Project.toml"
    output: manifest=f"{tool}/Manifest.toml"
    singularity: "docker://julia:1.12.2-bookworm"
    shell: 
        """
        julia --project={tool} -e 'using Pkg;Pkg.instantiate()'
        """

rule run_extendablefem_simulation:
    input: 
        parameters = lambda wildcards: configuration_to_parameter_file[wildcards.configuration],
        mesh = f"{result_dir}/mesh/mesh_{{configuration}}.msh",
        manifest = f"{tool}/Manifest.toml",
    output:
        zip = f"{result_dir}/{{tool}}/solution_field_data_{{configuration}}.zip",
        metrics = f"{result_dir}/{{tool}}/solution_metrics_{{configuration}}.json",
    singularity: "docker://julia:1.12.2-bookworm"
    shell:
        """
        julia --project={tool} {tool}/run_extendablefem_simulation.jl --configfile {input.parameters} --meshfile {input.mesh} --outputzip {output.zip} --outputmetrics {output.metrics}
        """

