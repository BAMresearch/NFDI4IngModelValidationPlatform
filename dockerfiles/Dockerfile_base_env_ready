# Use Ubuntu base image under x86_64 emulation for Apple Silicon Macs
FROM --platform=linux/amd64 ubuntu:22.04

# Prevent interactive prompts during package installs
ENV DEBIAN_FRONTEND=noninteractive

# Update system and install required packages
RUN apt-get update && apt-get install -y \
    wget git build-essential curl unzip \
    && rm -rf /var/lib/apt/lists/*

# Install Miniforge (Conda for ARM/x86 compatible builds)
ENV CONDA_DIR=/opt/miniforge
RUN wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh -O /tmp/miniforge.sh && \
    bash /tmp/miniforge.sh -b -p $CONDA_DIR && \
    rm /tmp/miniforge.sh
ENV PATH=$CONDA_DIR/bin:$PATH

# Initialize Conda shell integration
RUN conda init bash

# Create default working directory
WORKDIR /NFDI_Benchmark

# Copy your repository into the image (optional; or mount it later)
# COPY . /NFDI_Benchmark

# Pre-install mamba (faster environment management)
RUN conda install -y mamba -n base -c conda-forge

# Create and activate a base environment for model validation
RUN mamba create -n model-validation python=3.10 -y && \
    echo "source $CONDA_DIR/etc/profile.d/conda.sh && conda activate model-validation" >> ~/.bashrc

# Set environment variables for stability under emulation
ENV OMP_NUM_THREADS=1
ENV KMP_AFFINITY=disabled

# Default command starts bash with Conda activated
ENTRYPOINT ["/bin/bash", "-l"]